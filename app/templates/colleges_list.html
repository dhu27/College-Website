{% extends "base.html" %}
{% block title %}Explore Colleges{% endblock %}

{% block content %}

<div class="colleges-list-container">

  <!-- Sidebar Filters -->
  <form method="get" action="{{ url_for('colleges.college_list') }}" class="colleges-filters">
    <h3>Filter</h3>

    <strong>Search by College Name</strong>
    <input type="text" name="search" value="{{ request.args.get('search', '') }}" placeholder="e.g. Stanford, Tech">

    <strong>Control Type</strong>
    <label><input type="checkbox" name="control" value="public" {% if 'public' in request.args.getlist('control') %}checked{% endif %}> Public</label>
    <label><input type="checkbox" name="control" value="private" {% if 'private' in request.args.getlist('control') %}checked{% endif %}> Private</label>

    <strong>Max Cost of Attendance ($)</strong>
    <input type="range" name="max_cost" min="0" max="120000" step="500"
          value="{{ request.args.get('max_cost', 120000) }}"
          oninput="document.getElementById('costLabel').innerText = this.value">
    <span id="costLabel">{{ request.args.get('max_cost', 120000) }}</span>

    <strong>Student Body Size</strong>
    <label><input type="checkbox" name="size" value="small" {% if 'small' in request.args.getlist('size') %}checked{% endif %}> Small (&lt;5K)</label>
    <label><input type="checkbox" name="size" value="medium" {% if 'medium' in request.args.getlist('size') %}checked{% endif %}> Medium (5Kâ€“15K)</label>
    <label><input type="checkbox" name="size" value="large" {% if 'large' in request.args.getlist('size') %}checked{% endif %}> Large (&gt;15K)</label>

    <strong>Specialties</strong>
    {% for spec in ['All-Women', 'All-Men', 'AANAPISI', 'HBCU', 'NATIVE AMERICAN'] %}
      <label><input type="checkbox" name="specialties" value="{{ spec }}" {% if spec in request.args.getlist('specialties') %}checked{% endif %}> {{ spec }}</label>
    {% endfor %}

    <strong>Selectivity</strong>
    {% for level in ['Extremely Selective', 'Very Selective', 'Selective', 'Average', 'Safety'] %}
      <label><input type="checkbox" name="selectivity" value="{{ level }}" {% if level in request.args.getlist('selectivity') %}checked{% endif %}> {{ level }}</label>
    {% endfor %}

    <label for="state"><strong>State</strong></label>
    <select name="state" id="state">
      <option value="">All</option>
      {% for abbr in [
        'AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS',
        'KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY',
        'NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'
      ] %}
        <option value="{{ abbr }}" {% if request.args.get('state') == abbr %}selected{% endif %}>{{ abbr }}</option>
      {% endfor %}
    </select>

    <input type="submit" value="Apply Filters">
    <a href="{{ url_for('colleges.college_list') }}">Reset</a>
  </form>

  <!-- College Cards -->
  <div class="colleges-content">
    <h2>Colleges</h2>

    {% for college in colleges.items %}
      <div class="college-card">
        <h3><a href="{{ url_for('colleges.college_detail', college_id=college.id) }}">{{ college.name }}</a></h3>

        {% if college.description %}
          <p class="college-description">
            {{ college.description[:365] }}{% if college.description|length > 365 %}...{% endif %}
          </p>
        {% else %}
          <p class="college-description">No description available.</p>
        {% endif %}

        <div class="college-meta">
          <span>{{ college.city }}, {{ college.state }}</span>
          <span>Admission Rate: {{ (college.admission_rate * 100)|round(1) if college.admission_rate else 'N/A' }}%</span>
          <span>Annual Cost: ${{ "{:,}".format(college.cost_of_attendance) if college.cost_of_attendance else "N/A" }}</span>
          <div class="add-to-list-btn-wrapper" style="position: relative; display: inline-block;">
            <button class="add-to-list-btn" data-college-id="{{ college.id }}">Add to List</button>
            <div class="list-dropdown" data-college-id="{{ college.id }}">
              <form class="add-to-list-form">
                <div class="user-lists-menu">
                  <div class="dropdown-section-title">Your Lists</div>
                  <ul class="user-lists">
                    {% for user_list in user_lists %}
                      <li>
                        <button type="button" class="add-to-list-option" data-list-id="{{ user_list.id }}" data-college-id="{{ college.id }}">
                          {{ user_list.name }}
                        </button>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
                <input type="text" class="new-list-name" placeholder="New list name">
                <div class="form-buttons">
                  <button type="button" class="create-list-btn">Create New List</button>
                  <button type="submit" class="add-to-list-submit">Add to List</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <p>No colleges match your filters.</p>
    {% endfor %}

    {% set args = request.args.to_dict() %}
    {% set query_args = {} %}
    {% for key, value in args.items() if key != 'page' %}
      {% set _ = query_args.__setitem__(key, value) %}
    {% endfor %}

    <div class="colleges-pagination">
      {% if colleges.has_prev %}
        <a href="{{ url_for('colleges.college_list', page=colleges.prev_num, **query_args) }}">Previous</a>
      {% endif %}
      <span>Page {{ colleges.page }} of {{ colleges.pages }}</span>
      {% if colleges.has_next %}
        <a href="{{ url_for('colleges.college_list', page=colleges.next_num, **query_args) }}">Next</a>
      {% endif %}
    </div>

  </div>
</div>

<script src="{{ url_for('static', filename='js/add-to-list.js') }}"></script>
{% endblock %}
